<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Segurança de Vazamentos Químicos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #0a0e17;
            --secondary: #1a1f2e;
            --accent: #4ecdc4;
            --danger: #ff6b6b;
            --warning: #ff9c5a;
            --safe: #4ecdc4;
            --text: #e0e0e0;
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .connected {
            background-color: var(--safe);
            box-shadow: 0 0 10px var(--safe);
        }

        .disconnected {
            background-color: var(--danger);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-title i {
            margin-right: 10px;
            color: var(--accent);
        }

        .data-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .temp-value {
            color: var(--warning);
        }

        .humidity-value {
            color: #5ab3ff;
        }

        .exhaust-control {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .exhaust-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .fan-status {
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-on {
            background-color: var(--safe);
            box-shadow: 0 0 10px var(--safe);
        }

        .status-off {
            background-color: #95a5a6;
        }

        .toggle-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn i {
            margin-right: 8px;
        }

        .toggle-btn:hover {
            background: #3bbcb4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .toggle-btn:active {
            transform: translateY(0);
        }

        .alert-section {
            margin-top: 30px;
        }

        .alert-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--danger);
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .alert-list {
            list-style: none;
        }

        .alert-item {
            background: rgba(255, 107, 107, 0.2);
            border-left: 4px solid var(--danger);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 107, 107, 0);
            }
        }

        .alert-item i {
            margin-right: 15px;
            color: var(--danger);
        }

        .gas-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .gas-indicator {
            text-align: center;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gas-name {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .gas-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .safe {
            color: var(--safe);
        }

        .warning {
            color: var(--warning);
        }

        .danger {
            color: var(--danger);
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Sistema de Segurança de Vazamentos Químicos</h1>
            <p class="subtitle">Monitoramento em tempo real - Laboratório de Química</p>
            <div class="connection-status">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span id="connectionText">Desconectado da ESP32</span>
            </div>
        </header>

        <div class="dashboard">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-temperature-high"></i>
                    TEMPERATURA
                </div>
                <div class="data-value temp-value" id="temperature">24°C</div>
                <div>Sensor DHT11</div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-tint"></i>
                    UMIDADE
                </div>
                <div class="data-value humidity-value" id="humidity">45%</div>
                <div>Sensor DHT11</div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-wind"></i>
                    QUALIDADE DO AR
                </div>
                <div class="data-value" id="airQuality" style="color: var(--warning);">Moderada</div>
                <div>Sensor MQ-135</div>
            </div>
        </div>

        <div class="exhaust-control">
            <div class="exhaust-title">EXAUSTOR</div>
            <div class="fan-status">
                <div class="status-indicator status-off" id="exhaustStatus"></div>
                <span id="exhaustStatusText">Exaustor Desligado</span>
            </div>
            <button class="toggle-btn" id="exhaustToggle">
                <i class="fas fa-power-off"></i>
                <span id="exhaustButtonText">Ligar Exaustor</span>
            </button>
        </div>

        <div class="alert-section">
            <div class="alert-title">ALERTAS!</div>
            <ul class="alert-list" id="alertList">
                <!-- Alertas serão adicionados dinamicamente -->
            </ul>
        </div>

        <div class="footer">
            <p>Conectado à ESP32 | Sensores: DHT11 e MQ-135</p>
            <p>Status do Sistema: <span id="systemStatus" style="color: var(--warning);">Monitorando</span> | Última
                atualização: <span id="updateTime">15:42:03</span></p>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const exhaustToggle = document.getElementById('exhaustToggle');
        const exhaustStatus = document.getElementById('exhaustStatus');
        const exhaustStatusText = document.getElementById('exhaustStatusText');
        const exhaustButtonText = document.getElementById('exhaustButtonText');
        const updateTimeElement = document.getElementById('updateTime');
        const statusDot = document.getElementById('statusDot');
        const connectionText = document.getElementById('connectionText');
        const systemStatus = document.getElementById('systemStatus');
        const alertList = document.getElementById('alertList');

        // Elementos dos sensores
        const temperatureElement = document.getElementById('temperature');
        const humidityElement = document.getElementById('humidity');
        const airQualityElement = document.getElementById('airQuality');

        // Estado do sistema
        let isExhaustOn = false;
        let isConnected = false;
        let lastExhaustState = false;
        let sensorData = {
            temperature: 24,
            humidity: 45,
            airQuality: 'Moderada'
        };

        // Configuração da conexão (substitua pelo IP da sua ESP32)
        const ESP_IP = '192.168.1.100'; // Altere para o IP da sua ESP32
        const API_BASE = `http://${ESP_IP}`;
        const UPDATE_INTERVAL = 5000; // 5 segundos

        // Alternar estado do exaustor
        exhaustToggle.addEventListener('click', async function () {
            try {
                isExhaustOn = !isExhaustOn;
                const endpoint = isExhaustOn ? '/exhaust/on' : '/exhaust/off';

                // Enviar comando para a ESP32
                const response = await fetch(`${API_BASE}${endpoint}`);

                if (response.ok) {
                    updateExhaustStatus();
                    // Adicionar alerta sobre mudança manual do exaustor
                    addAlert(`Exaustor ${isExhaustOn ? 'ligado' : 'desligado'} manualmente`, isExhaustOn ? 'on' : 'off');
                } else {
                    throw new Error('Falha ao controlar exaustor');
                }
            } catch (error) {
                console.error('Erro ao controlar exaustor:', error);
                alert('Erro ao comunicar com a ESP32. Verifique a conexão.');
                isExhaustOn = !isExhaustOn; // Reverter estado em caso de erro
            }
        });

        // Atualizar interface do exaustor
        function updateExhaustStatus() {
            if (isExhaustOn) {
                exhaustStatus.classList.remove('status-off');
                exhaustStatus.classList.add('status-on');
                exhaustStatusText.textContent = 'Exaustor Ligado';
                exhaustButtonText.textContent = 'Desligar Exaustor';
                exhaustToggle.style.background = 'var(--danger)';
            } else {
                exhaustStatus.classList.remove('status-on');
                exhaustStatus.classList.add('status-off');
                exhaustStatusText.textContent = 'Exaustor Desligado';
                exhaustButtonText.textContent = 'Ligar Exaustor';
                exhaustToggle.style.background = 'var(--accent)';
            }
        }

        // Atualizar horário
        function updateDateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR');
            updateTimeElement.textContent = timeString;
        }

        // Buscar dados dos sensores da ESP32
        async function fetchSensorData() {
            try {
                const response = await fetch(`${API_BASE}/sensors`);
                if (response.ok) {
                    const data = await response.json();
                    updateSensorData(data);
                    updateConnectionStatus(true);

                    // Verificar se o estado do exaustor mudou (controle automático)
                    checkExhaustStateChange(data);
                } else {
                    throw new Error('Falha ao obter dados');
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                updateConnectionStatus(false);
            }
        }

        // Verificar se o estado do exaustor mudou (para controle automático)
        function checkExhaustStateChange(data) {
            // Verificar se há informação sobre o estado do exaustor nos dados
            if (data.hasOwnProperty('exhaustOn')) {
                const currentExhaustState = data.exhaustOn;

                // Se o estado mudou desde a última verificação
                if (currentExhaustState !== lastExhaustState) {
                    isExhaustOn = currentExhaustState;
                    updateExhaustStatus();

                    // Adicionar alerta sobre mudança automática do exaustor
                    addAlert(`Exaustor ${isExhaustOn ? 'ligado' : 'desligado'} automaticamente`, isExhaustOn ? 'on' : 'off');

                    // Atualizar o último estado conhecido
                    lastExhaustState = currentExhaustState;
                }
            }
        }

        // Atualizar dados dos sensores na interface
        function updateSensorData(data) {
            sensorData = { ...sensorData, ...data };

            // Atualizar elementos da interface
            temperatureElement.textContent = `${data.temperature || '--'}°C`;
            humidityElement.textContent = `${data.humidity || '--'}%`;
            airQualityElement.textContent = data.airQuality || '--';

            // Atualizar horário da última atualização
            updateDateTime();
        }

        // Atualizar status de conexão
        function updateConnectionStatus(connected) {
            isConnected = connected;

            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                connectionText.textContent = 'Conectado à ESP32';
                systemStatus.textContent = 'Monitorando';
                systemStatus.style.color = 'var(--safe)';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                connectionText.textContent = 'Desconectado da ESP32';
                systemStatus.textContent = 'Erro de conexão';
                systemStatus.style.color = 'var(--danger)';
            }
        }

        // Atualizar alertas com base no estado do exaustor
        function updateAlerts() {
            // Esta função agora é mantida apenas para compatibilidade
            // Os alertas são gerados diretamente quando ocorrem mudanças no estado do exaustor
        }

        // Adicionar alerta à lista
        function addAlert(message, type) {
            const alertItem = document.createElement('li');
            alertItem.className = 'alert-item';

            if (type === 'off') {
                alertItem.style.background = 'rgba(78, 205, 196, 0.2)';
                alertItem.style.borderLeftColor = 'var(--safe)';
            }

            const icon = document.createElement('i');
            icon.className = type === 'off' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
            icon.style.color = type === 'off' ? 'var(--safe)' : 'var(--danger)';

            const text = document.createElement('span');
            text.textContent = message;

            alertItem.appendChild(icon);
            alertItem.appendChild(text);

            // Adicionar à lista de alertas
            alertList.appendChild(alertItem);

            // Manter apenas os 5 alertas mais recentes
            if (alertList.children.length > 5) {
                alertList.removeChild(alertList.children[0]);
            }
        }

        // Inicializar a aplicação
        function initApp() {
            updateDateTime();
            updateExhaustStatus();

            // Adicionar alerta inicial
            addAlert('Sistema iniciado. Aguardando eventos do exaustor.', 'off');

            // Buscar dados imediatamente e a cada intervalo
            fetchSensorData();
            setInterval(fetchSensorData, UPDATE_INTERVAL);
        }

        // Iniciar a aplicação quando o documento estiver carregado
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>

</html>